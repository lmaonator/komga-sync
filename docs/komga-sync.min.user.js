// ==UserScript==
// @name        komga-sync
// @version     1.2.0
// @author      lmaonator
// @description Sync manga chapter progress with tracking websites.
// @license     GPL-3.0-or-later
// @homepageURL https://lmaonator.github.io/komga-sync/
// @downloadURL https://lmaonator.github.io/komga-sync/komga-sync.min.user.js
// @supportURL  https://github.com/lmaonator/komga-sync/issues
// @namespace   https://github.com/lmaonator/komga-sync
// @match       http*://komga.*/*
// @match       http*://*/komga/*
// @match       https://lmaonator.github.io/komga-sync/auth-*.html*
// @grant       GM.xmlHttpRequest
// @grant       GM.getValue
// @grant       GM.setValue
// @grant       GM.deleteValue
// @grant       GM.openInTab
// ==/UserScript==
!function(){"use strict";const e={NUMBER_PATTERN:"([0-9]+)(.[0-9]+)?(.?[a-z]+)?",get basic(){return new RegExp(`(?<=ch\\.) *${this.NUMBER_PATTERN}`)},get number(){return new RegExp(this.NUMBER_PATTERN)},unwanted:/\b(?:v|ver|vol|version|volume|season|s)[^a-z]?[0-9]+/g,unwantedWhiteSpace:/\s(?=extra|special|omake)/g,unwantedYear:/[([][^)\]]*(?:19|20)\d\d(?:[-.]\d\d)?[-. )\]]/g,unwantedRsolution:/\(x\d{4}\)/g,parseChapterNumber:function(e,t){let n=t.toLowerCase();n=n.replaceAll(e.toLowerCase(),"").trim(),n=n.replaceAll("_"," "),n=n.replaceAll(this.unwantedYear,""),n=n.replaceAll(this.unwantedRsolution,""),n=n.replaceAll(",",".").replaceAll("-","."),n=n.replaceAll(this.unwantedWhiteSpace,""),n=n.replaceAll(this.unwanted,"");let a=n.match(this.basic);if(null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}if(a=n.match(this.number),null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}return-1},getChapterNumberFromMatch:function(e){let t=Number(e[1]),n=e[2]??null,a=e[3]??null;return t+this.checkForDecimal(n,a)},checkForDecimal:function(e,t){if(null!==e&&""!==e)return Number(e);if(null!==t&&""!==t){if(t.includes("extra"))return.99;if(t.includes("omake"))return.98;if(t.includes("special"))return.97;const e=t.replace(/^\.+/,"");if(1==e.length)return this.parseAlphaPostFix(e[0])}return 0},parseAlphaPostFix:function(e){const t=e.charCodeAt()-("a".charCodeAt()-1);return t>=10?0:t/10}};const t="https://graphql.anilist.co";async function n(e,n){const a=await GM.getValue("anilist_access_token");return new Promise(((i,s)=>{GM.xmlHttpRequest({url:t,method:"POST",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({query:e,variables:n}),onload:async e=>(400===e.status&&e.responseText.includes("Invalid token")&&(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")),i(e)),onerror:e=>(console.error(e),s(e))})}))}const a={getToken:async function(){return await GM.getValue("anilist_access_token")},checkTokenExpiration:async function(){const e=await GM.getValue("anilist_expires_at",null);null!==e&&(e<=Date.now()?(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")):e-6048e5<=Date.now()&&alert("AniList session will expire soon, please login again."))},openOAuth:function(){const e=new URLSearchParams({client_id:atob("MTYzNDc"),response_type:"token"});GM.openInTab("https://anilist.co/api/v2/oauth/authorize?"+e.toString())},handleOAuthRedirect:async function(){const e=new URL(window.location.href),t=new URLSearchParams(e.hash.slice(1)),n=t.get("access_token");null!==n?(await GM.setValue("anilist_access_token",n),await GM.setValue("anilist_expires_at",1e3*parseInt(t.get("expires_in"),10)+Date.now()),document.body.appendChild(document.createTextNode("Successfully authenticated with AniList ‚úÖ. You can now close this window."))):document.body.appendChild(document.createTextNode("Failed to authenticate with AniList ‚ö†Ô∏è. Please try again."))},updateEntry:async function(e,t){t=Math.floor(t);let a=await n("\nquery ($id: Int) {\n    Media(id: $id, type: MANGA) {\n        id\n        chapters\n        mediaListEntry {\n            id\n            status\n            progress\n            repeat\n            startedAt {\n                year\n                month\n                day\n            }\n            completedAt {\n                year\n                month\n                day\n            }\n        }\n    }\n}\n",{id:e}),i=JSON.parse(a.responseText);if(i.errors?.length>0)return console.error(i.errors),!1;const s=i.data.Media,o=s.mediaListEntry;if(o.progress>=t)return!0;const r=new Date,l={year:r.getFullYear(),month:r.getMonth()+1,day:r.getDate()},d={progress:t};if(s.chapters==t?(d.status="COMPLETED",d.completedAt=l):d.status="CURRENT",void 0===o)d.mediaId=e,d.startedAt=l;else{if(!["CURRENT","DROPPED","PAUSED","PLANNING"].includes(o.status))return!0;d.id=o.id}return a=await n("\nmutation (\n    $id: Int, $mediaId: Int,\n    $status: MediaListStatus, $progress: Int, $repeat: Int,\n    $startedAt: FuzzyDateInput, $completedAt: FuzzyDateInput\n) {\n    SaveMediaListEntry (\n        id: $id, mediaId: $mediaId,\n        status: $status, progress: $progress, repeat: $repeat,\n        startedAt: $startedAt, completedAt: $completedAt\n    ) {\n        id\n        mediaId\n        status\n        progress\n        repeat\n        startedAt {\n            year\n            month\n            day\n        }\n        completedAt {\n            year\n            month\n            day\n        }\n    }\n}\n",d),i=JSON.parse(a.responseText),!(i.errors?.length>0)||(console.error(i.errors),!1)},search:async function(e){const n={query:"\nquery ($search: String) {\n    Page {\n        media(search: $search, type: MANGA) {\n        id\n        idMal\n        title {\n            romaji\n            english\n            native\n        }\n        format\n        startDate {\n            year\n        }\n        coverImage {\n            medium\n        }\n        synonyms\n        siteUrl\n        }\n    }\n}\n",variables:{search:e}};return new Promise(((e,a)=>{GM.xmlHttpRequest({url:t,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(n),onload:t=>e(JSON.parse(t.responseText)),onerror:a})}))}};async function i(e){await GM.setValue("config",JSON.stringify(e))}function s(e,t){const n=e.series[t];return void 0===n||null===n.parseFileForChapterNumber?e.parseFileForChapterNumber:n.parseFileForChapterNumber}class o extends HTMLElement{constructor(e){super(),this.keyCode="KeyX",this.fileNamePrefix=e??"",this.isOpen=!1,this.touch=!1,this.longTouchTimeout=void 0,this.longTouchDuration=1e3}keyHandler=e=>{"Escape"===e.code&&this.isOpen?(e.stopPropagation(),this.close()):e.code===this.keyCode&&(this.isOpen?this.close():this.open())};pointerDownHandler=e=>{clearTimeout(this.longTouchTimeout),this.longTouchTimeout=setTimeout((()=>{this.isOpen?this.close():(this.touch="mouse"!==e.pointerType,this.open())}),this.longTouchDuration)};pointerUpHandler=()=>{clearTimeout(this.longTouchTimeout)};connectedCallback(){this.shadow=this.attachShadow({mode:"open"});const e=document.createElement("style");e.textContent=".ui {\n    z-index: 300;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(#000000, #444444);\n    touch-action: none;\n}\n\n.legend {\n    z-index: 305;\n    position: fixed;\n    left: 10px;\n    top: 10px;\n    padding: 5px;\n    user-select: none;\n    pointer-events: none;\n    background-color: rgba(18, 18, 18, 0.6);\n    border: 1px solid rgba(105, 105, 105, 0.6);\n    border-radius: 10px;\n    color: #ffffff;\n    font-family: Roboto, sans-serif;\n    font-size: 14px;\n}\n\n.legend div {\n    margin: 5px;\n}\n\n.legend div.legend-title {\n    font-size: 18px;\n    font-weight: bold;\n    margin-bottom: 10px;\n}\n\n.page {\n    width: 100%;\n    height: 100%;\n    object-fit: contain;\n}\n\n.page.hide-cursor {\n    cursor: none;\n}\n\n.crosshair {\n    z-index: 320;\n    position: fixed;\n    left: 0;\n    top: 0;\n    background-color: #ff0000;\n    user-select: none;\n    pointer-events: none;\n}\n\n.crosshair.hidden {\n    visibility: hidden;\n    display: none;\n}\n\n.crosshair-x {\n    width: 1px;\n    height: 100%;\n}\n\n.crosshair-y {\n    width: 100%;\n    height: 1px;\n}\n\n.selection {\n    z-index: 310;\n    position: fixed;\n    background-color: rgba(255, 0, 0, 0.5);\n    user-select: none;\n    pointer-events: none;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n}\n\n.save {\n    border: 0;\n    background-color: transparent;\n    pointer-events: auto;\n    cursor: pointer;\n    width: 90%;\n    height: 90%;\n}\n\n.drag {\n    position: absolute;\n    z-index: 330;\n    cursor: grab;\n    background-color: rgba(100, 100, 100, 0.7);\n    width: 30px;\n    height: 30px;\n    pointer-events: auto;\n    box-sizing: border-box;\n    border: 0 solid #000000;\n}\n\n.drag:hover {\n    background-color: rgba(200, 200, 200, 0.9);\n}\n\n.drag.top,\n.drag.bottom {\n    width: 100%;\n    margin: 0 30px;\n    border-width: 1px 0;\n}\n\n.drag.left,\n.drag.right {\n    height: 100%;\n    border-width: 0 1px;\n}\n\n.drag.top {\n    top: 0;\n    transform: translate(0, -100%);\n}\n\n.drag.right {\n    right: 0;\n    transform: translate(100%, 0);\n}\n\n.drag.bottom {\n    bottom: 0;\n    transform: translate(0, 100%);\n}\n\n.drag.left {\n    left: 0;\n    transform: translate(-100%, 0);\n}\n\n.drag.tl,\n.drag.tr,\n.drag.br,\n.drag.bl {\n    width: 30px;\n    height: 30px;\n    border-width: 1px;\n}\n\n.drag.tl {\n    top: 0;\n    left: 0;\n    transform: translate(-100%, -100%);\n}\n\n.drag.tr {\n    top: 0;\n    right: 0;\n    transform: translate(100%, -100%);\n}\n\n.drag.br {\n    bottom: 0;\n    right: 0;\n    transform: translate(100%, 100%);\n}\n\n.drag.bl {\n    bottom: 0;\n    left: 0;\n    transform: translate(-100%, 100%);\n}\n",this.shadow.appendChild(e),window.addEventListener("keydown",this.keyHandler,!0),window.addEventListener("pointerdown",this.pointerDownHandler),window.addEventListener("pointerup",this.pointerUpHandler),window.addEventListener("pointercancel",this.pointerUpHandler)}disconnectedCallback(){window.removeEventListener("keydown",this.keyHandler,!0),window.removeEventListener("pointerdown",this.pointerDownHandler),window.removeEventListener("pointerup",this.pointerUpHandler),window.removeEventListener("pointercancel",this.pointerUpHandler)}close(){this.isOpen&&(this.ui.remove(),this.isOpen=!1)}open(){this.isOpen=!0,this.ui=document.createElement("div"),this.ui.classList.add("ui");const e=document.createElement("div");e.classList.add("legend"),this.ui.appendChild(e),e.insertAdjacentHTML("afterbegin",`\n<div class="legend-title">Crop-Tool</div>\n<div><b>${this.touch?"Touch and hold":"Press ESC / X"}</b> to cancel.</div>\n<div><b>${this.touch?"Touch":"Click"}</b> to set start and end point.</div>\n<div><b>Drag</b> sides or corners to adjust selection.</div>\n<div><b>${this.touch?"Touch":"Click"}</b> the selection to download.</div>\n`);const{page:t,imageUrl:n}=this.getPageAndImageUrl(),a=document.createElement("img");a.src=n.href,a.classList.add("page","hide-cursor"),this.ui.appendChild(a),a.addEventListener("contextmenu",(e=>{e.preventDefault()}));const i=document.createElement("div"),s=document.createElement("div");i.classList.add("crosshair","crosshair-x"),s.classList.add("crosshair","crosshair-y"),this.touch||(i.style.left=document.body.offsetWidth/2+"px",s.style.top=document.body.offsetHeight/2+"px",this.ui.appendChild(i),this.ui.appendChild(s));const o=document.createElement("div"),r=document.createElement("div");o.classList.add("crosshair","crosshair-x","hidden"),r.classList.add("crosshair","crosshair-y","hidden"),this.ui.appendChild(o),this.ui.appendChild(r);const l={x:0,y:0,state:0,dragging:!1,dragPos:"top",dragBase:{x:0,y:0}};this.ui.addEventListener("pointermove",(e=>{if(0===l.state?(i.style.left=e.clientX+"px",s.style.top=e.clientY+"px"):1===l.state&&(o.style.left=e.clientX+"px",r.style.top=e.clientY+"px"),1===l.state&&(c.style.left=Math.min(l.x,e.clientX)+"px",c.style.width=Math.abs(e.clientX-l.x)+"px",c.style.top=Math.min(l.y,e.clientY)+"px",c.style.height=Math.abs(e.clientY-l.y)+"px"),l.dragging){const t=c.getBoundingClientRect(),n=l.dragPos,a=e.clientX,i=e.clientY,s=i-l.dragBase.y,o=a-l.dragBase.x;("top"==n||"tl"==n||"tr"==n)&&t.height-s>=0?(c.style.top=t.top+s+"px",c.style.height=t.height-s+"px",l.dragBase.y=i):("bottom"==n||"bl"==n||"br"==n)&&t.height+s>=0&&(c.style.bottom=t.bottom-s+"px",c.style.height=t.height+s+"px",l.dragBase.y=i),("right"==n||"tr"==n||"br"==n)&&t.width+o>=0&&(c.style.right=t.right-o+"px",c.style.width=t.width+o+"px",l.dragBase.x=a),("left"==n||"tl"==n||"bl"==n)&&t.width-o>=0&&(c.style.left=t.left+o+"px",c.style.width=t.width-o+"px",l.dragBase.x=a)}}));const d=()=>{l.dragging&&(l.dragging=!1)};this.ui.addEventListener("pointerup",d),this.ui.addEventListener("pointercancel",d);const c=document.createElement("div");c.classList.add("selection"),c.style.left=0,c.style.top=0,c.style.width=0,c.style.height=0,this.ui.appendChild(c);const p=()=>{const e=c.getBoundingClientRect(),n=this.getClickedPixel(a,e.left,e.top),i=this.getClickedPixel(a,e.right,e.bottom),s=this.cropImage(a,n,i);this.downloadImage(s,`${this.fileNamePrefix} - ${t} crop.png`),this.close()};a.addEventListener("click",(e=>{0===l.state?(l.state=1,l.x=e.clientX,l.y=e.clientY,c.style.left=e.clientX+"px",c.style.top=e.clientY+"px",o.style.left=e.clientX+"px",r.style.top=e.clientY+"px",o.classList.remove("hidden"),r.classList.remove("hidden")):1===l.state&&(l.state=2,c.style.width=Math.abs(l.x-e.clientX)+"px",c.style.height=Math.abs(l.y-e.clientY)+"px",i.classList.add("hidden"),s.classList.add("hidden"),o.classList.add("hidden"),r.classList.add("hidden"),a.classList.remove("hide-cursor"),["top","right","bottom","left","tl","tr","bl","br"].map((e=>{const t=document.createElement("div");return t.classList.add("drag",e),c.appendChild(t),t.addEventListener("pointerdown",(t=>{t.stopPropagation(),l.dragging=!0,l.dragPos=e,l.dragBase.x=t.clientX,l.dragBase.y=t.clientY})),t})),(()=>{const e=document.createElement("button");e.classList.add("save"),e.tabIndex=-1,c.appendChild(e),e.addEventListener("click",p)})())})),this.shadow.appendChild(this.ui)}getPageAndImageUrl(){const e=new URL(window.location.href),t=e.pathname.match(/book\/([^/]+)\/read/)[1],n=e.searchParams.get("page");return{page:n,imageUrl:new URL(e.origin+`/api/v1/books/${t}/pages/${n}`)}}cropImage(e,t,n){const a=document.createElement("canvas"),i=Math.abs(n.x-t.x),s=Math.abs(n.y-t.y);a.width=i,a.height=s;return a.getContext("2d").drawImage(e,Math.min(t.x,n.x),Math.min(t.y,n.y),i,s,0,0,i,s),a.toDataURL("image/png")}downloadImage(e,t){const n=document.createElement("a");n.href=e,n.download=t,n.click()}getRenderedImageRect(e){const t=e.naturalWidth/e.naturalHeight;let n,a;return t>e.width/e.height?(n=e.width,a=n/t):(a=e.height,n=a*t),{width:n,height:a,x:(e.width-n)/2,y:(e.height-a)/2}}getClickedPixel(e,t,n){const a=this.getRenderedImageRect(e),i=e.naturalWidth/a.width,s=e.naturalHeight/a.height;let o=Math.floor((t-a.x)*i),r=Math.floor((n-a.y)*s);return o=Math.max(0,Math.min(o,e.naturalWidth)),r=Math.max(0,Math.min(r,e.naturalHeight)),{x:o,y:r}}}customElements.define("crop-tool",o);const r="https://api.mangaupdates.com/v1";async function l(e,t,n){const a=await GM.getValue("mu_session_token");return new Promise(((i,s)=>{GM.xmlHttpRequest({url:r+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},data:void 0!==n?JSON.stringify(n):void 0,onload:e=>(401===e.status&&(GM.deleteValue("mu_session_token"),alert("MangaUpdates session expired, please login again.")),i(e)),onerror:e=>(console.error(e),s(e))})}))}const d={login:async function(e){const t="[komga-sync] ",n=document.createElement("div");n.classList.add("mu-login"),e.appendChild(n);const a=document.createElement("form");n.appendChild(a),a.insertAdjacentHTML("afterbegin",'\n<div class="mu-login-title">MangaUpdates Login</div>\n<div class="mu-login-desc">\nNote: The MangaUpdates API does not support OAuth.\nUsername and password are required to create a session token.\n</div>\n<div id="mu-login-error"></div>\n<div>\n<label for="mu-username">Username:</label>\n<input type="text" id="mu-username" name="username" required>\n</div>\n<div>\n<label for="mu-password">Password:</label>\n<input type="password" id="mu-password" name="password" required>\n</div>\n<div>\n<button type="submit">Login</button>\n<button type="button">Cancel</button>\n</div>'),a.querySelector("button:nth-child(2)").addEventListener("click",(()=>n.remove())),a.addEventListener("submit",(e=>{e.preventDefault();const i=new FormData(a);GM.xmlHttpRequest({url:r+"/account/login",method:"PUT",headers:{"Content-Type":"application/json"},data:JSON.stringify({username:i.get("username"),password:i.get("password")}),onload:async e=>{const i=JSON.parse(e.responseText);"success"===i.status?(await GM.setValue("mu_session_token",i.context.session_token),await GM.setValue("mu_uid",i.context.uid),console.log(t+"MangaUpdates login successful"),n.remove()):(a.querySelector("#mu-login-error").textContent="‚ö†Ô∏è"+i.reason,console.error(t+"MangaUpdates login failed:",i.reason))},onerror:e=>console.error(t+"MangaUpdates login error",e)})}))},getToken:async function(){return await GM.getValue("mu_session_token")},updateSeries:async function(e,t){if(t=Math.floor(t),""===await GM.getValue("mu_session_token",""))return!1;const n={series:{id:e},status:{chapter:t}};let a="/lists/series",i=await l("/lists/series/"+e,"GET");if(404===i.status)n.list_id=0;else{if(JSON.parse(i.responseText).status.chapter>=t)return!0;a+="/update"}return i=await l(a,"POST",[n]),200===i.status},search:async function(e){return new Promise(((t,n)=>{GM.xmlHttpRequest({url:r+"/series/search",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({search:e}),onload:e=>t(JSON.parse(e.responseText)),onerror:n})}))}},c="https://myanimelist.net/v1/oauth2",p="https://api.myanimelist.net/v2",u="ZjE4NDIxNGY4MTg4Y2RmNzEwZmM4N2MwMzMzYzhlMGM";function m(e){const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let n="";for(let a=e;a>0;--a)n+=t[Math.floor(62*Math.random())];return n}async function h(e,t){const n={client_id:atob(u),client_secret:""};void 0!==e&&void 0!==t?Object.assign(n,{grant_type:"authorization_code",code:e,code_verifier:t}):Object.assign(n,{grant_type:"refresh_token",refresh_token:await GM.getValue("mal_refresh_token")});const a=new URLSearchParams(n).toString();return new Promise(((e,t)=>{GM.xmlHttpRequest({url:c+"/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:a,onload:t=>{if(200===t.status){const n=JSON.parse(t.responseText);return GM.setValue("mal_access_token",n.access_token),GM.setValue("mal_refresh_token",n.refresh_token),GM.setValue("mal_expires_at",Date.now()+2592e6),e(!0)}return alert("MyAnimeList session expired, please login again."),console.error(t),e(!1)},onerror:e=>(console.error(e),t(!1))})}))}async function g(e,t,n){const a=await GM.getValue("mal_access_token");let i=n;return void 0!==i&&(i=new URLSearchParams(i).toString()),new Promise(((s,o)=>{GM.xmlHttpRequest({url:p+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/x-www-form-urlencoded"},data:i,onload:async a=>401===a.status&&await h()?g(e,t,n):s(a),onerror:e=>(console.error(e),o(e))})}))}const f={getToken:async function(){return await GM.getValue("mal_access_token")},checkTokenExpiration:async function(){const e=await GM.getValue("mal_expires_at",null);null!==e&&e<=Date.now()&&(await GM.deleteValue("mal_access_token"),await GM.deleteValue("mal_expires_at"),alert("MyAnimeList session has expired, please login again."))},openOAuth:async function(){const e=m(16),t=m(64);await GM.setValue("mal_state",e),await GM.setValue("mal_challenge",t);const n=new URLSearchParams({response_type:"code",client_id:atob(u),state:e,code_challenge:t,code_challenge_method:"plain"});GM.openInTab(c+"/authorize?"+n.toString())},handleOAuthRedirect:async function(){const e=new URL(window.location.href),t=await GM.getValue("mal_state");if(e.searchParams.get("state")!==t)return void document.body.appendChild(document.createTextNode("Error: Authorization state does not match"));const n=await GM.getValue("mal_challenge"),a=e.searchParams.get("code");await h(a,n).catch((()=>!1))?document.body.appendChild(document.createTextNode("Successfully authenticated with MyAnimeList ‚úÖ. You can now close this window.")):document.body.appendChild(document.createTextNode("Failed to authenticate with MyAnimeList ‚ö†Ô∏è. Error details were logged to console.")),GM.deleteValue("mal_state"),GM.deleteValue("mal_challenge")},updateStatus:async function(e,t){t=Math.floor(t);let n=await g("/manga/"+e+"?fields=my_list_status,num_chapters,status","GET");const a=JSON.parse(n.responseText),i=a.my_list_status??{is_rereading:!1,num_chapters_read:0,status:"plan_to_read"};if(i.num_chapters_read>=t)return!0;const s={num_chapters_read:t},o=(new Date).toISOString().substring(0,10);return"plan_to_read"===i.status?(s.status="reading",void 0===i.start_date&&(s.start_date=o)):"reading"===i.status&&t>=a.num_chapters&&"finished"===a.status&&(s.status="completed",void 0===i.finish_date&&(s.finish_date=o)),n=await g("/manga/"+e+"/my_list_status","PATCH",s),200===n.status},search:async function(e){const t=new URL(p+"/manga");return t.searchParams.set("q",e),t.searchParams.set("fields","start_date, media_type, alternative_titles"),t.searchParams.set("nsfw","true"),new Promise(((e,n)=>{GM.xmlHttpRequest({url:t.toString(),method:"GET",headers:{"X-MAL-CLIENT-ID":atob(u)},onload:t=>e(JSON.parse(t.responseText)),onerror:n})}))},randStr:m};(async()=>{const t="[komga-sync] ";if("komga-sync MAL auth"===document.title)return f.handleOAuthRedirect();if("komga-sync AniList auth"===document.title)return a.handleOAuthRedirect();if(!document.title.startsWith("Komga"))return;const n=await async function(){const e={parseFileForChapterNumber:!1,series:{}};return Object.assign(e,JSON.parse(await GM.getValue("config","{}"))),e}(),r={id:"",title:"",number:"0",pagesCount:0,seriesId:"",seriesTitle:"",completed:!1,links:[]};let l=!1,c=!1;setInterval((async()=>{const p=new URL(window.location.href);let m=p.pathname.match(/series\/([^/]+)/);if(m){const e=m[1];if(!l){const t=document.querySelector("main header > div.v-toolbar__content div.spacer");if(null===t)return;const s=document.createElement("button");s.className="v-btn v-btn--icon v-btn--round theme--dark v-size--default",s.style.width="120px",s.textContent="Komga Sync",s.addEventListener("click",(()=>{!async function(e){const t=document.createElement("div");t.classList.add("modal");const s=document.createElement("div");s.classList.add("content"),t.appendChild(s);const o=document.createElement("div");o.classList.add("header"),s.appendChild(o);const r=document.createElement("div");r.classList.add("header-title"),r.textContent="Komga-Sync",o.appendChild(r);const l=document.createElement("div");o.appendChild(l);const c=document.createElement("button");function p(){t.remove(),u.removeEventListener("click",m),window.removeEventListener("keydown",g)}function m(e){e.target==t&&p()}function g(e){"Escape"===e.code&&p()}c.textContent="‚ùå",l.appendChild(c),c.addEventListener("click",p),u.addEventListener("click",m),window.addEventListener("keydown",g);const b=document.createElement("div");b.classList.add("global-conf"),s.appendChild(b);const y=document.createElement("div");b.appendChild(y);const w=function(e){const t=document.createElement("div");function n(t){switch(t.target.value){case"komga":e.parseFileForChapterNumber=!1;break;case"file":e.parseFileForChapterNumber=!0}i(e)}return t.insertAdjacentHTML("afterbegin",`\n<div class="global-conf-title">Global Configuration</div>\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file" id="config-parse-file-komga"\n        value="komga" ${!1===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-komga">Komga</label>\n    <input type="radio" name="config-parse-file" id="config-parse-file-file"\n        value="file" ${!0===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-file">Parse Filename</label>\n</div>`),t.querySelector("#config-parse-file-komga").addEventListener("change",n),t.querySelector("#config-parse-file-file").addEventListener("change",n),t}(n);b.appendChild(w);const x=document.createElement("button");x.textContent="MangaUpdates Login",x.className="login-button",y.appendChild(x),x.addEventListener("click",(()=>{d.login(y)})),void 0!==await d.getToken()&&y.appendChild(document.createTextNode(" Logged in ‚úÖ"));y.appendChild(document.createElement("br"));const v=document.createElement("button");v.textContent="MyAnimeList Login",v.className="login-button",y.appendChild(v),v.addEventListener("click",f.openOAuth),void 0!==await f.getToken()&&y.appendChild(document.createTextNode(" Logged in ‚úÖ"));y.appendChild(document.createElement("br"));const C=document.createElement("button");C.textContent="AniList Login",C.className="login-button",y.appendChild(C),C.addEventListener("click",a.openOAuth),void 0!==await a.getToken()&&y.appendChild(document.createTextNode(" Logged in ‚úÖ"));const L=await fetch("/api/v1/series/"+e),k=await L.json(),E=document.createElement("h2");E.textContent=k.metadata.title??k.name,s.appendChild(E);const M=function(e,t){e.series[t]||(e.series[t]={parseFileForChapterNumber:null});const n=e.series[t],a=document.createElement("div");function s(t){switch(t.target.value){case"global":n.parseFileForChapterNumber=null;break;case"komga":n.parseFileForChapterNumber=!1;break;case"file":n.parseFileForChapterNumber=!0}i(e)}return a.insertAdjacentHTML("afterbegin",`\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-global"\n        value="global" ${null===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-global">Global Setting</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-komga"\n        value="komga" ${!1===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-komga">Komga</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-file"\n        value="file" ${!0===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-file">Parse Filename</label>\n</div>\n`),a.querySelector("#config-parse-file-series-global").addEventListener("change",s),a.querySelector("#config-parse-file-series-komga").addEventListener("change",s),a.querySelector("#config-parse-file-series-file").addEventListener("change",s),a}(n,e);M.classList.add("series-conf"),s.appendChild(M);const _={mu:"",mal:"",al:""};for(const e of k.metadata.links){switch(e.label){case"MangaUpdates":_.mu=e.url;break;case"MyAnimeList":_.mal=e.url;break;case"AniList":_.al=e.url}switch(new URL(e.url).hostname){case"mangaupdates.com":case"www.mangaupdates.com":_.mu||(_.mu=e.url);break;case"myanimelist.net":case"www.myanimelist.net":_.mal||(_.mal=e.url);break;case"anilist.co":case"www.anilist.co":_.al||(_.al=e.url)}}function T(e,t,n){const a=document.createElement("label");a.textContent=e,n.appendChild(a);const i=document.createElement("input");i.type="url",i.value=t,n.appendChild(i);const s=document.createElement("button");return s.textContent="Search "+e,n.appendChild(document.createElement("br")),[i,s]}const A=document.createElement("div");A.classList.add("links");const[N,S]=T("MangaUpdates",_.mu,A),[P,G]=T("MyAnimeList",_.mal,A),[R,U]=T("AniList",_.al,A);let F=document.createElement("label");F.textContent="Search Term:",A.appendChild(F);const I=document.createElement("input");I.value=k.metadata.title??k.name,I.type="text",I.classList.add("search-input"),A.appendChild(I);const O=document.createElement("div");O.classList.add="button-container",O.appendChild(S),O.appendChild(G),O.appendChild(U),A.appendChild(O);const z=document.createElement("div");z.classList.add("button-note"),z.textContent=" Note: AniList has MyAnimeList IDs for most entries, if MAL is still missing it will also be added if available.",A.appendChild(z),s.appendChild(A);const $=async(t,n)=>{const a=k.metadata.links.filter((e=>e.label!==t));a.push({label:t,url:n});204===(await fetch("/api/v1/series/"+e+"/metadata",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({links:a})})).status&&(k.metadata.links=a)},q=(e,t,n)=>{const a=document.createElement("div");a.classList.add("result-container"),s.appendChild(a),h[e][t]=a,setTimeout((()=>delete h[e][t]),3e5);const i=document.createElement("h3");if(i.textContent=e+" Results",i.classList.add("result-header"),void 0!==n&&i.classList.add("result-header-with-note"),a.appendChild(i),void 0!==n){const e=document.createElement("div");e.classList.add("result-note"),e.textContent=n,a.appendChild(e)}const o=document.createElement("div");return o.classList.add("result-list"),a.appendChild(o),o},D=(e,t,n,a,i,s)=>{a=a.replace("_"," ").toLowerCase();const o=document.createElement("div");o.classList.add("result-card");const r=document.createElement("div");r.classList.add("thumb"),o.appendChild(r);const l=document.createElement("img");l.src=e,r.appendChild(l);const d=document.createElement("details");o.appendChild(d),l.addEventListener("click",(()=>{d.toggleAttribute("open")}));const c=document.createElement("summary");c.innerHTML=`${n} <a href="${t}" target="_blank">üîó</a> <span>${a}</span>`+(i?` [${i}]`:""),d.appendChild(c),d.insertAdjacentHTML("beforeend",s??"");const p=document.createElement("button");return p.textContent="Set URL",o.appendChild(p),{card:o,button:p}};S.addEventListener("click",(async()=>{const e=I.value.trim();if(u.querySelector(".result-container")?.remove(),h.MangaUpdates[e])return void s.appendChild(h.MangaUpdates[e]);const t=await d.search(e),n=q("MangaUpdates",e);for(const{record:e}of t.results){const{card:t,button:a}=D(e.image.url.thumb,e.url,e.title,e.type,e.year);a.addEventListener("click",(async()=>{N.value=e.url,await $("MangaUpdates",e.url)})),n.appendChild(t)}})),G.addEventListener("click",(async()=>{const e=I.value.trim();if(u.querySelector(".result-container")?.remove(),h.MyAnimeList[e])return void s.appendChild(h.MyAnimeList[e]);const t=await f.search(e),n=q("MyAnimeList",e,"Click on the series thumbnail or title to show synonyms.");for(const{node:e}of t.data){const t="https://myanimelist.net/manga/"+e.id,a=e.alternative_titles,{card:i,button:s}=D(e.main_picture.medium,t,e.title,e.media_type,e.start_date?.slice(0,4),(""!==a.en?a.en+"<br>":"")+a.ja+(a.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+a.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));s.addEventListener("click",(async()=>{P.value=t,await $("MyAnimeList",t)})),n.appendChild(i)}})),U.addEventListener("click",(async()=>{u.querySelector(".result-container")?.remove();const e=I.value.trim();if(h.AniList[e])return void s.appendChild(h.AniList[e]);const t=await a.search(e),n=q("AniList",e,"Click on the series thumbnail or title to show synonyms.");for(const e of t.data.Page.media){const{card:t,button:a}=D(e.coverImage.medium,e.siteUrl,e.title.english??e.title.romaji??e.title.native,e.format,e.startDate.year,(e.title.romaji?e.title.romaji+"<br>":"")+e.title.native+(e.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+e.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));a.addEventListener("click",(async()=>{if(await $("AniList",e.siteUrl),R.value=e.siteUrl,null!==e.idMal&&""===P.value){const t="https://myanimelist.net/manga/"+e.idMal;await $("MyAnimeList",t),P.value=t}})),n.appendChild(t)}})),u.appendChild(t)}(e),s.blur()})),t.parentNode.insertBefore(s,t.nextSibling),l=!0}}else l=!1;if(m=p.pathname.match(/book\/([^/]+)\/read/),m){if(r.id!==m[1]){r.id=m[1];let a=await fetch("/api/v1/books/"+r.id),i=await a.json();r.title=i.metadata.title,s(n,r.seriesId)?r.number=e.parseChapterNumber(i.seriesTitle,i.url):r.number=i.metadata.number,r.pagesCount=i.media.pagesCount,r.seriesId=i.seriesId,r.seriesTitle=i.seriesTitle,r.completed=!1,console.log(t+"Chapter opened: "+r.seriesTitle+" Ch. "+r.number+": "+r.title),a=await fetch("/api/v1/series/"+r.seriesId),i=await a.json(),r.links=i.metadata.links;const l=r.seriesTitle+" - Ch. "+r.number+" - "+r.title;document.body.appendChild(new o(l))}if("false"!==p.searchParams.get("incognito"))return;if(!r.completed&&Number(p.searchParams.get("page"))==r.pagesCount){r.completed=!0,console.log(t+"Chapter complete, syncing..");const e=[["MangaUpdates",d.updateSeries],["MyAnimeList",f.updateStatus],["AniList",a.updateEntry]];for(const[n,a]of e){const e=r.links.find((e=>e.label===n));if(e)try{const i=g(e.url);!0===await a(i,r.number)&&console.log(t+"Successfully synced with "+n)}catch(e){console.error(t+"Error syncing with "+n,e)}}}}else""!==r.id&&(console.log(t+"Chapter closed"),r.id="",document.querySelector("crop-tool").remove());if(m=p.pathname.match(/book\/([^/]+)\/?$/),null!==m){const t=document.querySelector("a.link-underline.text-h5")?.href.match(/series\/([^/]+)/)?.[1];void 0!==t&&(c=!(!c&&s(n,t))||function(){const t=document.querySelector("div.container.pa-6.container--fluid");if(null===t)return!1;const n=Array.from(t.children).find((e=>"FILE"===e.firstChild.textContent)).lastChild.textContent.split(/\/|\\/).pop(),a=t.querySelector("a.link-underline.text-h5").textContent.trim()??"",i=e.parseChapterNumber(a,n),s=document.createElement("div");s.className="row align-center text-caption";const o=document.createElement("div");o.className="py-1 text-uppercase col-sm-3 col-md-2 col-xl-1 col-4";const r=document.createElement("div");return r.className="py-1 col-sm-9 col-md-10 col-xl-11 col-8",o.textContent="Parsed Chapter",r.textContent=i,s.appendChild(o),s.appendChild(r),t.appendChild(s),!0}())}else c=!1}),250),f.checkTokenExpiration(),a.checkTokenExpiration();const p=document.createElement("div");document.body.appendChild(p);const u=p.attachShadow({mode:"open"}),m=document.createElement("style");m.textContent='.modal {\n    z-index: 300;\n    position: fixed;\n    padding-top: 100px;\n    transform: translate(0, 0);\n    left: 0;\n    top: 0;\n    bottom: 0;\n    right: 0;\n    width: auto;\n    height: auto;\n    overflow: auto;\n    background-color: rgba(0, 0, 0, 0.8);\n    overscroll-behavior: contain;\n}\n\n.header {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 0.5em;\n}\n\n.header-title {\n    font-size: 1.8em;\n    font-weight: bold;\n}\n\n.global-conf {\n    display: flex;\n    gap: 3em;\n}\n\n.global-conf-title {\n    font-weight: bold;\n    margin: 2px;\n    margin-bottom: 0.5em;\n}\n\n.global-conf input {\n    margin: 2px;\n}\n\n.global-conf label {\n    margin: 2px;\n}\n\n.series-conf {\n    margin-bottom: 0.5em;\n}\n\n.content {\n    font-family: Roboto, sans-serif;\n    font-size: 16px;\n    color: #ffffff;\n    background-color: #121212;\n    margin: auto;\n    width: 80%;\n    padding: 1em;\n    border: 1px solid #696969;\n    border-radius: 10px;\n}\n\nh2 {\n    margin-top: 1em;\n    margin-bottom: 0.5em;\n}\n\n.links label {\n    display: inline-block;\n    width: 120px;\n}\n\nbutton {\n    background-color: #303030;\n    border: 2px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    padding: 6px 16px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    font-size: 16px;\n    margin: 2px;\n    transition-duration: 0.2s;\n    cursor: pointer;\n}\n\nbutton:hover {\n    background-color: #ffffff;\n    color: #000000;\n}\n\n.login-button {\n    width: 200px;\n}\n\n.links input,\ninput[type="text"],\ninput[type="password"] {\n    padding: 5px;\n    margin: 2px;\n    box-sizing: border-box;\n    border: 1px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    background-color: #303030;\n    font-size: 16px;\n    width: 100%;\n    max-width: 800px;\n}\n\n.links .search-input {\n    margin-top: 16px;\n}\n\n.button-container {\n    margin-top: 8px;\n}\n\n.button-note {\n    font-size: 14px;\n    margin: 5px 2px;\n}\n\na {\n    text-decoration: none;\n    color: #ffffff;\n}\n\n.result-note {\n    font-size: 14px;\n    margin-bottom: 1em;\n}\n\n.result-header {\n    margin-top: 1em;\n    margin-bottom: 1em;\n}\n\n.result-header-with-note {\n    margin-bottom: 0.25em;\n}\n\n.result-list {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.5em;\n}\n\n.result-card {\n    border: 1px solid #000;\n    background-color: #232323;\n    flex-basis: 400px;\n    flex-grow: 1;\n}\n\n.result-card .thumb {\n    float: left;\n    margin-right: 4px;\n    width: 106px;\n}\n\n.result-card img {\n    display: block;\n    height: 150px;\n    width: 106px;\n    object-fit: contain;\n}\n\n.result-card details {\n    margin: 5px;\n}\n\n.result-card summary {\n    font-weight: bold;\n}\n\n.result-card summary span {\n    text-transform: capitalize;\n}\n\n.result-card button {\n    margin: 0.5em;\n    padding: 3px 8px;\n    border: 1px solid #404040;\n    font-size: 14px;\n}\n\n.result-card ul {\n    margin-top: 0.25em;\n    padding-left: 10px;\n    list-style: inside;\n    overflow: auto;\n}\n\n.mu-login {\n    z-index: 310;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.8);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n}\n\n.mu-login form {\n    width: 100%;\n    max-width: 540px;\n    background-color: #121212;\n    border: 1px solid #696969;\n    border-radius: 10px;\n    padding: 1em;\n}\n\n.mu-login div {\n    margin: 6px;\n}\n\n.mu-login .mu-login-title {\n    font-size: 1.5em;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n\n.mu-login .mu-login-desc {\n    font-size: smaller;\n    margin-bottom: 12px;\n}\n\n#mu-login-error {\n    color: #ff0000;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n',u.appendChild(m);const h={MangaUpdates:{},MyAnimeList:{},AniList:{}};function g(e){let t=e.match(/^https:\/\/(?:www\.)?mangaupdates\.com\/series\/([^/]+)/i);if(t)return parseInt(t[1],36);if(t=e.match(/^https:\/\/(?:www\.)?myanimelist\.net\/manga\/([^/]+)/i),t)return parseInt(t[1],10);if(t=e.match(/^https:\/\/(?:www\.)?anilist\.co\/manga\/([^/]+)/i),t)return parseInt(t[1],10);throw new Error("Invalid URL")}})()}();
