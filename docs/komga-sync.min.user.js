// ==UserScript==
// @name        komga-sync
// @version     1.1.0
// @author      lmaonator
// @description Sync manga chapter progress with tracking websites.
// @license     GPL-3.0-or-later
// @homepageURL https://lmaonator.github.io/komga-sync/
// @downloadURL https://lmaonator.github.io/komga-sync/komga-sync.min.user.js
// @supportURL  https://github.com/lmaonator/komga-sync/issues
// @namespace   https://github.com/lmaonator/komga-sync
// @match       http*://komga.*/*
// @match       http*://*/komga/*
// @match       https://lmaonator.github.io/komga-sync/auth-*.html*
// @grant       GM.xmlHttpRequest
// @grant       GM.getValue
// @grant       GM.setValue
// @grant       GM.deleteValue
// @grant       GM.openInTab
// ==/UserScript==
!function(){"use strict";const e={NUMBER_PATTERN:"([0-9]+)(.[0-9]+)?(.?[a-z]+)?",get basic(){return new RegExp(`(?<=ch\\.) *${this.NUMBER_PATTERN}`)},get number(){return new RegExp(this.NUMBER_PATTERN)},unwanted:/\b(?:v|ver|vol|version|volume|season|s)[^a-z]?[0-9]+/g,unwantedWhiteSpace:/\s(?=extra|special|omake)/g,unwantedYear:/[([][^)\]]*(?:19|20)\d\d(?:[-.]\d\d)?[-. )\]]/g,unwantedRsolution:/\(x\d{4}\)/g,parseChapterNumber:function(e,t){let n=t.toLowerCase();n=n.replaceAll(e.toLowerCase(),"").trim(),n=n.replaceAll("_"," "),n=n.replaceAll(this.unwantedYear,""),n=n.replaceAll(this.unwantedRsolution,""),n=n.replaceAll(",",".").replaceAll("-","."),n=n.replaceAll(this.unwantedWhiteSpace,""),n=n.replaceAll(this.unwanted,"");let a=n.match(this.basic);if(null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}if(a=n.match(this.number),null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}return-1},getChapterNumberFromMatch:function(e){let t=Number(e[1]),n=e[2]??null,a=e[3]??null;return t+this.checkForDecimal(n,a)},checkForDecimal:function(e,t){if(null!==e&&""!==e)return Number(e);if(null!==t&&""!==t){if(t.includes("extra"))return.99;if(t.includes("omake"))return.98;if(t.includes("special"))return.97;const e=t.replace(/^\.+/,"");if(1==e.length)return this.parseAlphaPostFix(e[0])}return 0},parseAlphaPostFix:function(e){const t=e.charCodeAt()-("a".charCodeAt()-1);return t>=10?0:t/10}};async function t(e){await GM.setValue("config",JSON.stringify(e))}function n(e,t){const n=e.series[t];return void 0===n||null===n.parseFileForChapterNumber?e.parseFileForChapterNumber:n.parseFileForChapterNumber}(async()=>{const a="[komga-sync] ",i="https://api.mangaupdates.com/v1",s="https://myanimelist.net/v1/oauth2",o="https://api.myanimelist.net/v2",r="https://anilist.co/api/v2/oauth",l="https://graphql.anilist.co",c="ZjE4NDIxNGY4MTg4Y2RmNzEwZmM4N2MwMzMzYzhlMGM",d="MTYzNDc";if("komga-sync MAL auth"===document.title)return async function(){const e=new URL(window.location.href),t=await GM.getValue("mal_state");if(e.searchParams.get("state")!==t)return void document.body.appendChild(document.createTextNode("Error: Authorization state does not match"));const n=await GM.getValue("mal_challenge"),a=e.searchParams.get("code");await w(a,n).catch((()=>!1))?document.body.appendChild(document.createTextNode("Successfully authenticated with MyAnimeList ✅. You can now close this window.")):document.body.appendChild(document.createTextNode("Failed to authenticate with MyAnimeList ⚠️. Error details were logged to console."));GM.deleteValue("mal_state"),GM.deleteValue("mal_challenge")}();if("komga-sync AniList auth"===document.title)return async function(){const e=new URL(window.location.href),t=new URLSearchParams(e.hash.slice(1)),n=t.get("access_token");null!==n?(await GM.setValue("anilist_access_token",n),await GM.setValue("anilist_expires_at",1e3*parseInt(t.get("expires_in"),10)+Date.now()),document.body.appendChild(document.createTextNode("Successfully authenticated with AniList ✅. You can now close this window."))):document.body.appendChild(document.createTextNode("Failed to authenticate with AniList ⚠️. Please try again."))}();if(!document.title.startsWith("Komga"))return;const u=await async function(){const e={parseFileForChapterNumber:!1,series:{}};return Object.assign(e,JSON.parse(await GM.getValue("config","{}"))),e}(),p={id:"",title:"",number:"0",pagesCount:0,seriesId:"",seriesTitle:"",completed:!1,links:[]};let m=!1,h=!1;setInterval((async()=>{const g=new URL(window.location.href);let f=g.pathname.match(/series\/([^/]+)/);if(f){const e=f[1];if(!m){const n=document.querySelector("main header > div.v-toolbar__content div.spacer");if(null===n)return;const p=document.createElement("button");p.className="v-btn v-btn--icon v-btn--round theme--dark v-size--default",p.style.width="120px",p.textContent="Komga Sync",p.addEventListener("click",(()=>{!async function(e){const n=document.createElement("div");n.classList.add("modal");const p=document.createElement("div");p.classList.add("content"),n.appendChild(p);const m=document.createElement("div");m.classList.add("header"),p.appendChild(m);const h=document.createElement("div");h.classList.add("header-title"),h.textContent="Komga-Sync",m.appendChild(h);const g=document.createElement("div");m.appendChild(g);const f=document.createElement("button");function b(){n.remove(),M.removeEventListener("click",y),window.removeEventListener("keydown",w)}function y(e){e.target==n&&b()}function w(e){"Escape"===e.code&&b()}f.textContent="❌",g.appendChild(f),f.addEventListener("click",b),M.addEventListener("click",y),window.addEventListener("keydown",w);const x=document.createElement("div");x.classList.add("global-conf"),p.appendChild(x);const v=document.createElement("div");x.appendChild(v);const C=function(e){const n=document.createElement("div");function a(n){switch(n.target.value){case"komga":e.parseFileForChapterNumber=!1;break;case"file":e.parseFileForChapterNumber=!0}t(e)}return n.insertAdjacentHTML("afterbegin",`\n<div class="global-conf-title">Global Configuration</div>\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file" id="config-parse-file-komga"\n        value="komga" ${!1===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-komga">Komga</label>\n    <input type="radio" name="config-parse-file" id="config-parse-file-file"\n        value="file" ${!0===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-file">Parse Filename</label>\n</div>`),n.querySelector("#config-parse-file-komga").addEventListener("change",a),n.querySelector("#config-parse-file-file").addEventListener("change",a),n}(u);x.appendChild(C);const L=document.createElement("button");L.textContent="MangaUpdates Login",L.className="login-button",v.appendChild(L),L.addEventListener("click",(async()=>{const e=document.createElement("div");e.classList.add("mu-login"),v.appendChild(e);const t=document.createElement("form");e.appendChild(t),t.insertAdjacentHTML("afterbegin",'\n<div class="mu-login-title">MangaUpdates Login</div>\n<div class="mu-login-desc">\n    Note: The MangaUpdates API does not support OAuth.\n    Username and password are required to create a session token.\n</div>\n<div id="mu-login-error"></div>\n<div>\n    <label for="mu-username">Username:</label>\n    <input type="text" id="mu-username" name="username" required>\n</div>\n<div>\n    <label for="mu-password">Password:</label>\n    <input type="password" id="mu-password" name="password" required>\n</div>\n<div>\n    <button type="submit">Login</button>\n    <button type="button">Cancel</button>\n</div>'),t.querySelector("button:nth-child(2)").addEventListener("click",(()=>e.remove())),t.addEventListener("submit",(n=>{n.preventDefault();const s=new FormData(t);GM.xmlHttpRequest({url:i+"/account/login",method:"PUT",headers:{"Content-Type":"application/json"},data:JSON.stringify({username:s.get("username"),password:s.get("password")}),onload:async n=>{const i=JSON.parse(n.responseText);"success"===i.status?(await GM.setValue("mu_session_token",i.context.session_token),await GM.setValue("mu_uid",i.context.uid),console.log(a+"MangaUpdates login successful"),e.remove()):(t.querySelector("#mu-login-error").textContent="⚠️"+i.reason,console.error(a+"MangaUpdates login failed:",i.reason))},onerror:e=>console.error(a+"MangaUpdates login error",e)})}))})),""!==await GM.getValue("mu_session_token","")&&v.appendChild(document.createTextNode(" Logged in ✅"));v.appendChild(document.createElement("br"));const _=document.createElement("button");_.textContent="MyAnimeList Login",_.className="login-button",v.appendChild(_),_.addEventListener("click",(async()=>{const e=A(16),t=A(64);await GM.setValue("mal_state",e),await GM.setValue("mal_challenge",t);const n=new URLSearchParams({response_type:"code",client_id:atob(c),state:e,code_challenge:t,code_challenge_method:"plain"});GM.openInTab(s+"/authorize?"+n.toString())})),""!==await GM.getValue("mal_access_token","")&&v.appendChild(document.createTextNode(" Logged in ✅"));v.appendChild(document.createElement("br"));const k=document.createElement("button");k.textContent="AniList Login",k.className="login-button",v.appendChild(k),k.addEventListener("click",(()=>{const e=new URLSearchParams({client_id:atob(d),response_type:"token"});GM.openInTab(r+"/authorize?"+e.toString())})),""!==await GM.getValue("anilist_access_token","")&&v.appendChild(document.createTextNode(" Logged in ✅"));const N=await fetch("/api/v1/series/"+e),S=await N.json(),T=document.createElement("h2");T.textContent=S.metadata.title??S.name,p.appendChild(T);const G=function(e,n){e.series[n]||(e.series[n]={parseFileForChapterNumber:null});const a=e.series[n],i=document.createElement("div");function s(n){switch(n.target.value){case"global":a.parseFileForChapterNumber=null;break;case"komga":a.parseFileForChapterNumber=!1;break;case"file":a.parseFileForChapterNumber=!0}t(e)}return i.insertAdjacentHTML("afterbegin",`\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-global"\n        value="global" ${null===a.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-global">Global Setting</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-komga"\n        value="komga" ${!1===a.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-komga">Komga</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-file"\n        value="file" ${!0===a.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-file">Parse Filename</label>\n</div>\n`),i.querySelector("#config-parse-file-series-global").addEventListener("change",s),i.querySelector("#config-parse-file-series-komga").addEventListener("change",s),i.querySelector("#config-parse-file-series-file").addEventListener("change",s),i}(u,e);G.classList.add("series-conf"),p.appendChild(G);const F={mu:"",mal:"",al:""};for(const e of S.metadata.links){switch(e.label){case"MangaUpdates":F.mu=e.url;break;case"MyAnimeList":F.mal=e.url;break;case"AniList":F.al=e.url}switch(new URL(e.url).hostname){case"mangaupdates.com":case"www.mangaupdates.com":F.mu||(F.mu=e.url);break;case"myanimelist.net":case"www.myanimelist.net":F.mal||(F.mal=e.url);break;case"anilist.co":case"www.anilist.co":F.al||(F.al=e.url)}}function P(e,t,n){const a=document.createElement("label");a.textContent=e,n.appendChild(a);const i=document.createElement("input");i.type="url",i.value=t,n.appendChild(i);const s=document.createElement("button");return s.textContent="Search "+e,n.appendChild(document.createElement("br")),[i,s]}const U=document.createElement("div");U.classList.add("links");const[R,I]=P("MangaUpdates",F.mu,U),[z,V]=P("MyAnimeList",F.mal,U),[q,$]=P("AniList",F.al,U);let O=document.createElement("label");O.textContent="Search Term:",U.appendChild(O);const j=document.createElement("input");j.value=S.metadata.title??S.name,j.type="text",j.classList.add("search-input"),U.appendChild(j);const D=document.createElement("div");D.classList.add="button-container",D.appendChild(I),D.appendChild(V),D.appendChild($),U.appendChild(D);const J=document.createElement("div");J.classList.add("button-note"),J.textContent=" Note: AniList has MyAnimeList IDs for most entries, if MAL is still missing it will also be added if available.",U.appendChild(J),p.appendChild(U);const H=async(t,n)=>{const a=S.metadata.links.filter((e=>e.label!==t));a.push({label:t,url:n});204===(await fetch("/api/v1/series/"+e+"/metadata",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({links:a})})).status&&(S.metadata.links=a)},Y=(e,t,n)=>{const a=document.createElement("div");a.classList.add("result-container"),p.appendChild(a),E[e][t]=a,setTimeout((()=>delete E[e][t]),3e5);const i=document.createElement("h3");if(i.textContent=e+" Results",i.classList.add("result-header"),void 0!==n&&i.classList.add("result-header-with-note"),a.appendChild(i),void 0!==n){const e=document.createElement("div");e.classList.add("result-note"),e.textContent=n,a.appendChild(e)}const s=document.createElement("div");return s.classList.add("result-list"),a.appendChild(s),s},B=(e,t,n,a,i,s)=>{a=a.replace("_"," ").toLowerCase();const o=document.createElement("div");o.classList.add("result-card");const r=document.createElement("div");r.classList.add("thumb"),o.appendChild(r);const l=document.createElement("img");l.src=e,r.appendChild(l);const c=document.createElement("details");o.appendChild(c),l.addEventListener("click",(()=>{c.toggleAttribute("open")}));const d=document.createElement("summary");d.innerHTML=`${n} <a href="${t}" target="_blank">🔗</a> <span>${a}</span> [${i}]`,c.appendChild(d),c.insertAdjacentHTML("beforeend",s??"");const u=document.createElement("button");return u.textContent="Set URL",o.appendChild(u),{card:o,button:u}};I.addEventListener("click",(async()=>{const e=j.value.trim();M.querySelector(".result-container")?.remove(),E.MangaUpdates[e]?p.appendChild(E.MangaUpdates[e]):GM.xmlHttpRequest({url:i+"/series/search",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({search:e}),onload:t=>{const n=JSON.parse(t.responseText),a=Y("MangaUpdates",e);for(const{record:e}of n.results){const{card:t,button:n}=B(e.image.url.thumb,e.url,e.title,e.type,e.year);n.addEventListener("click",(async()=>{R.value=e.url,await H("MangaUpdates",e.url)})),a.appendChild(t)}},onerror:e=>console.error(e)})})),V.addEventListener("click",(async()=>{const e=j.value.trim();if(M.querySelector(".result-container")?.remove(),E.MyAnimeList[e])return void p.appendChild(E.MyAnimeList[e]);const t=new URL(o+"/manga");t.searchParams.set("q",e),t.searchParams.set("fields","start_date, media_type, alternative_titles"),t.searchParams.set("nsfw","true"),GM.xmlHttpRequest({url:t.toString(),method:"GET",headers:{"X-MAL-CLIENT-ID":atob(c)},onload:t=>{const n=JSON.parse(t.responseText),a=Y("MyAnimeList",e,"Click on the series thumbnail or title to show synonyms.");for(const{node:e}of n.data){const t="https://myanimelist.net/manga/"+e.id,n=e.alternative_titles,{card:i,button:s}=B(e.main_picture.medium,t,e.title,e.media_type,e.start_date.slice(0,4),(""!==n.en?n.en+"<br>":"")+n.ja+(n.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+n.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));s.addEventListener("click",(async()=>{z.value=t,await H("MyAnimeList",t)})),a.appendChild(i)}},onerror:e=>console.error(e)})})),$.addEventListener("click",(async()=>{M.querySelector(".result-container")?.remove();const e=j.value.trim();if(E.AniList[e])return void p.appendChild(E.AniList[e]);const t={query:"\n                    query ($search: String) {\n                        Page {\n                            media(search: $search, type: MANGA) {\n                            id\n                            idMal\n                            title {\n                                romaji\n                                english\n                                native\n                            }\n                            format\n                            startDate {\n                                year\n                            }\n                            coverImage {\n                                medium\n                            }\n                            synonyms\n                            siteUrl\n                            }\n                        }\n                    }\n                ",variables:{search:e}};GM.xmlHttpRequest({url:l,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(t),onload:t=>{const n=JSON.parse(t.responseText),a=Y("AniList",e,"Click on the series thumbnail or title to show synonyms.");for(const e of n.data.Page.media){const{card:t,button:n}=B(e.coverImage.medium,e.siteUrl,e.title.english??e.title.romaji??e.title.native,e.format,e.startDate.year,(e.title.romaji?e.title.romaji+"<br>":"")+e.title.native+(e.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+e.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));n.addEventListener("click",(async()=>{if(await H("AniList",e.siteUrl),q.value=e.siteUrl,null!==e.idMal&&""===z.value){const t="https://myanimelist.net/manga/"+e.idMal;await H("MyAnimeList",t),z.value=t}})),a.appendChild(t)}},onerror:e=>console.error(e)})})),M.appendChild(n)}(e),p.blur()})),n.parentNode.insertBefore(p,n.nextSibling),m=!0}}else m=!1;if(f=g.pathname.match(/book\/([^/]+)\/read/),f){if(p.id!==f[1]){p.id=f[1];let t=await fetch("/api/v1/books/"+p.id),i=await t.json();p.title=i.metadata.title,n(u,p.seriesId)?p.number=e.parseChapterNumber(i.seriesTitle,i.url):p.number=i.metadata.number,p.pagesCount=i.media.pagesCount,p.seriesId=i.seriesId,p.seriesTitle=i.seriesTitle,p.completed=!1,console.log(a+"Chapter opened: "+p.seriesTitle+" Ch. "+p.number+": "+p.title),t=await fetch("/api/v1/series/"+p.seriesId),i=await t.json(),p.links=i.metadata.links}if("false"!==g.searchParams.get("incognito"))return;if(!p.completed&&Number(g.searchParams.get("page"))==p.pagesCount){p.completed=!0,console.log(a+"Chapter complete, syncing..");const e=[["MangaUpdates",y],["MyAnimeList",v],["AniList",L]];for(const[t,n]of e){const e=p.links.find((e=>e.label===t));if(e)try{!0===await n(e.url,p.number)&&console.log(a+"Successfully synced with "+t)}catch(e){console.error(a+"Error syncing with "+t,e)}}}}else""!==p.id&&(console.log(a+"Chapter closed"),p.id="");if(f=g.pathname.match(/book\/([^/]+)\/?$/),null!==f){const t=document.querySelector("a.link-underline.text-h5")?.href.match(/series\/([^/]+)/)?.[1];void 0!==t&&(h=!(!h&&n(u,t))||function(){const t=document.querySelector("div.container.pa-6.container--fluid");if(null===t)return!1;const n=Array.from(t.children).find((e=>"FILE"===e.firstChild.textContent)).lastChild.textContent.split(/\/|\\/).pop(),a=t.querySelector("a.link-underline.text-h5").textContent.trim()??"",i=e.parseChapterNumber(a,n),s=document.createElement("div");s.className="row align-center text-caption";const o=document.createElement("div");o.className="py-1 text-uppercase col-sm-3 col-md-2 col-xl-1 col-4";const r=document.createElement("div");return r.className="py-1 col-sm-9 col-md-10 col-xl-11 col-8",o.textContent="Parsed Chapter",r.textContent=i,s.appendChild(o),s.appendChild(r),t.appendChild(s),!0}())}else h=!1}),250);const g=await GM.getValue("mal_expires_at",null);null!==g&&g<=Date.now()&&(await GM.deleteValue("mal_access_token"),await GM.deleteValue("mal_expires_at"),alert("MyAnimeList session has expired, please login again."));const f=await GM.getValue("anilist_expires_at",null);async function b(e,t,n){const a=await GM.getValue("mu_session_token");return new Promise(((s,o)=>{GM.xmlHttpRequest({url:i+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},data:void 0!==n?JSON.stringify(n):void 0,onload:e=>(401===e.status&&(GM.setValue("mu_session_token",""),alert("MangaUpdates session expired, please login again.")),s(e)),onerror:e=>(console.error(e),o(e))})}))}async function y(e,t){t=Math.floor(t);if(""===await GM.getValue("mu_session_token",""))return!1;const n={series:{id:N(e)},status:{chapter:t}};let a="/lists/series",i=await b("/lists/series/"+N(e),"GET");if(404===i.status)n.list_id=0;else{if(JSON.parse(i.responseText).status.chapter>=t)return!0;a+="/update"}return i=await b(a,"POST",[n]),200===i.status}async function w(e,t){const n={client_id:atob(c),client_secret:""};void 0!==e&&void 0!==t?Object.assign(n,{grant_type:"authorization_code",code:e,code_verifier:t}):Object.assign(n,{grant_type:"refresh_token",refresh_token:await GM.getValue("mal_refresh_token")});const a=new URLSearchParams(n).toString();return new Promise(((e,t)=>{GM.xmlHttpRequest({url:s+"/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:a,onload:t=>{if(200===t.status){const n=JSON.parse(t.responseText);return GM.setValue("mal_access_token",n.access_token),GM.setValue("mal_refresh_token",n.refresh_token),GM.setValue("mal_expires_at",Date.now()+2592e6),e(!0)}return alert("MyAnimeList session expired, please login again."),console.error(t),e(!1)},onerror:e=>(console.error(e),t(!1))})}))}async function x(e,t,n){const a=await GM.getValue("mal_access_token");let i=n;return void 0!==i&&(i=new URLSearchParams(i).toString()),new Promise(((s,r)=>{GM.xmlHttpRequest({url:o+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/x-www-form-urlencoded"},data:i,onload:async a=>401===a.status&&await w()?x(e,t,n):s(a),onerror:e=>(console.error(e),r(e))})}))}async function v(e,t){const n=N(e);t=Math.floor(t);let a=await x("/manga/"+n+"?fields=my_list_status,num_chapters,status","GET");const i=JSON.parse(a.responseText),s=i.my_list_status??{is_rereading:!1,num_chapters_read:0,status:"plan_to_read"};if(s.num_chapters_read>=t)return!0;const o={num_chapters_read:t},r=(new Date).toISOString().substring(0,10);return"plan_to_read"===s.status?(o.status="reading",void 0===s.start_date&&(o.start_date=r)):"reading"===s.status&&t>=i.num_chapters&&"finished"===i.status&&(o.status="completed",void 0===s.finish_date&&(o.finish_date=r)),a=await x("/manga/"+n+"/my_list_status","PATCH",o),200===a.status}async function C(e,t){const n=await GM.getValue("anilist_access_token");return new Promise(((a,i)=>{GM.xmlHttpRequest({url:l,method:"POST",headers:{Authorization:"Bearer "+n,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({query:e,variables:t}),onload:async e=>(400===e.status&&e.responseText.includes("Invalid token")&&(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")),a(e)),onerror:e=>(console.error(e),i(e))})}))}async function L(e,t){const n=N(e);t=Math.floor(t);let a=await C("\n            query ($id: Int) {\n                Media(id: $id, type: MANGA) {\n                    id\n                    chapters\n                    mediaListEntry {\n                        id\n                        status\n                        progress\n                        repeat\n                        startedAt {\n                            year\n                            month\n                            day\n                        }\n                        completedAt {\n                            year\n                            month\n                            day\n                        }\n                    }\n                }\n            }\n            ",{id:n}),i=JSON.parse(a.responseText);if(i.errors?.length>0)return console.error(i.errors),!1;const s=i.data.Media,o=s.mediaListEntry;if(o.progress>=t)return!0;const r=new Date,l={year:r.getFullYear(),month:r.getMonth()+1,day:r.getDate()},c={progress:t};if(s.chapters==t?(c.status="COMPLETED",c.completedAt=l):c.status="CURRENT",void 0===o)c.mediaId=n,c.startedAt=l;else{if(!["CURRENT","DROPPED","PAUSED","PLANNING"].includes(o.status))return!0;c.id=o.id}return a=await C("\n            mutation (\n                $id: Int, $mediaId: Int,\n                $status: MediaListStatus, $progress: Int, $repeat: Int,\n                $startedAt: FuzzyDateInput, $completedAt: FuzzyDateInput\n            ) {\n                SaveMediaListEntry (\n                    id: $id, mediaId: $mediaId,\n                    status: $status, progress: $progress, repeat: $repeat,\n                    startedAt: $startedAt, completedAt: $completedAt\n                ) {\n                    id\n                    mediaId\n                    status\n                    progress\n                    repeat\n                    startedAt {\n                        year\n                        month\n                        day\n                    }\n                    completedAt {\n                        year\n                        month\n                        day\n                    }\n                }\n            }\n            ",c),i=JSON.parse(a.responseText),!(i.errors?.length>0)||(console.error(i.errors),!1)}null!==f&&(f<=Date.now()?(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")):f-6048e5<=Date.now()&&alert("AniList session will expire soon, please login again."));const _=document.createElement("div");document.body.appendChild(_);const M=_.attachShadow({mode:"open"}),k=document.createElement("style");k.textContent='.modal {\n    z-index: 300;\n    position: fixed;\n    padding-top: 100px;\n    transform: translate(0, 0);\n    left: 0;\n    top: 0;\n    bottom: 0;\n    right: 0;\n    width: auto;\n    height: auto;\n    overflow: auto;\n    background-color: rgba(0, 0, 0, 0.8);\n    overscroll-behavior: contain;\n}\n\n.header {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 0.5em;\n}\n\n.header-title {\n    font-size: 1.8em;\n    font-weight: bold;\n}\n\n.global-conf {\n    display: flex;\n    gap: 3em;\n}\n\n.global-conf-title {\n    font-weight: bold;\n    margin: 2px;\n    margin-bottom: 0.5em;\n}\n\n.global-conf input {\n    margin: 2px;\n}\n\n.global-conf label {\n    margin: 2px;\n}\n\n.series-conf {\n    margin-bottom: 0.5em;\n}\n\n.content {\n    font-family: Roboto, sans-serif;\n    font-size: 16px;\n    color: #ffffff;\n    background-color: #121212;\n    margin: auto;\n    width: 80%;\n    padding: 1em;\n    border: 1px solid #696969;\n    border-radius: 10px;\n}\n\nh2 {\n    margin-top: 1em;\n    margin-bottom: 0.5em;\n}\n\n.links label {\n    display: inline-block;\n    width: 120px;\n}\n\nbutton {\n    background-color: #303030;\n    border: 2px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    padding: 6px 16px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    font-size: 16px;\n    margin: 2px;\n    transition-duration: 0.2s;\n    cursor: pointer;\n}\n\nbutton:hover {\n    background-color: #ffffff;\n    color: #000000;\n}\n\n.login-button {\n    width: 200px;\n}\n\n.links input,\ninput[type="text"],\ninput[type="password"] {\n    padding: 5px;\n    margin: 2px;\n    box-sizing: border-box;\n    border: 1px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    background-color: #303030;\n    font-size: 16px;\n    width: 100%;\n    max-width: 800px;\n}\n\n.links .search-input {\n    margin-top: 16px;\n}\n\n.button-container {\n    margin-top: 8px;\n}\n\n.button-note {\n    font-size: 14px;\n    margin: 5px 2px;\n}\n\na {\n    text-decoration: none;\n    color: #ffffff;\n}\n\n.result-note {\n    font-size: 14px;\n    margin-bottom: 1em;\n}\n\n.result-header {\n    margin-top: 1em;\n    margin-bottom: 1em;\n}\n\n.result-header-with-note {\n    margin-bottom: 0.25em;\n}\n\n.result-list {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.5em;\n}\n\n.result-card {\n    border: 1px solid #000;\n    background-color: #232323;\n    flex-basis: 400px;\n    flex-grow: 1;\n}\n\n.result-card .thumb {\n    float: left;\n    margin-right: 4px;\n    width: 106px;\n}\n\n.result-card img {\n    display: block;\n    height: 150px;\n    width: 106px;\n    object-fit: contain;\n}\n\n.result-card details {\n    margin: 5px;\n}\n\n.result-card summary {\n    font-weight: bold;\n}\n\n.result-card summary span {\n    text-transform: capitalize;\n}\n\n.result-card button {\n    margin: 0.5em;\n    padding: 3px 8px;\n    border: 1px solid #404040;\n    font-size: 14px;\n}\n\n.result-card ul {\n    margin-top: 0.25em;\n    padding-left: 10px;\n    list-style: inside;\n    overflow: auto;\n}\n\n.mu-login {\n    z-index: 310;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.8);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n}\n\n.mu-login form {\n    width: 100%;\n    max-width: 540px;\n}\n\n.mu-login div {\n    margin: 6px;\n}\n\n.mu-login .mu-login-title {\n    font-size: 1.5em;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n\n.mu-login .mu-login-desc {\n    font-size: smaller;\n    margin-bottom: 12px;\n}\n\n#mu-login-error {\n    color: #ff0000;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n',M.appendChild(k);const E={MangaUpdates:{},MyAnimeList:{},AniList:{}};function N(e){let t=e.match(/^https:\/\/(?:www\.)?mangaupdates\.com\/series\/([^/]+)/i);if(t)return parseInt(t[1],36);if(t=e.match(/^https:\/\/(?:www\.)?myanimelist\.net\/manga\/([^/]+)/i),t)return parseInt(t[1],10);if(t=e.match(/^https:\/\/(?:www\.)?anilist\.co\/manga\/([^/]+)/i),t)return parseInt(t[1],10);throw new Error("Invalid URL")}function A(e){const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let n="";for(let a=e;a>0;--a)n+=t[Math.floor(62*Math.random())];return n}})()}();
