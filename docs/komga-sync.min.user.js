// ==UserScript==
// @name        komga-sync
// @version     1.1.1
// @author      lmaonator
// @description Sync manga chapter progress with tracking websites.
// @license     GPL-3.0-or-later
// @homepageURL https://lmaonator.github.io/komga-sync/
// @downloadURL https://lmaonator.github.io/komga-sync/komga-sync.min.user.js
// @supportURL  https://github.com/lmaonator/komga-sync/issues
// @namespace   https://github.com/lmaonator/komga-sync
// @match       http*://komga.*/*
// @match       http*://*/komga/*
// @match       https://lmaonator.github.io/komga-sync/auth-*.html*
// @grant       GM.xmlHttpRequest
// @grant       GM.getValue
// @grant       GM.setValue
// @grant       GM.deleteValue
// @grant       GM.openInTab
// ==/UserScript==
!function(){"use strict";const e={NUMBER_PATTERN:"([0-9]+)(.[0-9]+)?(.?[a-z]+)?",get basic(){return new RegExp(`(?<=ch\\.) *${this.NUMBER_PATTERN}`)},get number(){return new RegExp(this.NUMBER_PATTERN)},unwanted:/\b(?:v|ver|vol|version|volume|season|s)[^a-z]?[0-9]+/g,unwantedWhiteSpace:/\s(?=extra|special|omake)/g,unwantedYear:/[([][^)\]]*(?:19|20)\d\d(?:[-.]\d\d)?[-. )\]]/g,unwantedRsolution:/\(x\d{4}\)/g,parseChapterNumber:function(e,t){let n=t.toLowerCase();n=n.replaceAll(e.toLowerCase(),"").trim(),n=n.replaceAll("_"," "),n=n.replaceAll(this.unwantedYear,""),n=n.replaceAll(this.unwantedRsolution,""),n=n.replaceAll(",",".").replaceAll("-","."),n=n.replaceAll(this.unwantedWhiteSpace,""),n=n.replaceAll(this.unwanted,"");let a=n.match(this.basic);if(null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}if(a=n.match(this.number),null!==a){const e=this.getChapterNumberFromMatch(a);if(!isNaN(e))return e}return-1},getChapterNumberFromMatch:function(e){let t=Number(e[1]),n=e[2]??null,a=e[3]??null;return t+this.checkForDecimal(n,a)},checkForDecimal:function(e,t){if(null!==e&&""!==e)return Number(e);if(null!==t&&""!==t){if(t.includes("extra"))return.99;if(t.includes("omake"))return.98;if(t.includes("special"))return.97;const e=t.replace(/^\.+/,"");if(1==e.length)return this.parseAlphaPostFix(e[0])}return 0},parseAlphaPostFix:function(e){const t=e.charCodeAt()-("a".charCodeAt()-1);return t>=10?0:t/10}};const t="https://graphql.anilist.co";async function n(e,n){const a=await GM.getValue("anilist_access_token");return new Promise(((i,s)=>{GM.xmlHttpRequest({url:t,method:"POST",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({query:e,variables:n}),onload:async e=>(400===e.status&&e.responseText.includes("Invalid token")&&(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")),i(e)),onerror:e=>(console.error(e),s(e))})}))}const a={getToken:async function(){return await GM.getValue("anilist_access_token")},checkTokenExpiration:async function(){const e=await GM.getValue("anilist_expires_at",null);null!==e&&(e<=Date.now()?(await GM.deleteValue("anilist_access_token"),await GM.deleteValue("anilist_expires_at"),alert("AniList session has expired, please login again.")):e-6048e5<=Date.now()&&alert("AniList session will expire soon, please login again."))},openOAuth:function(){const e=new URLSearchParams({client_id:atob("MTYzNDc"),response_type:"token"});GM.openInTab("https://anilist.co/api/v2/oauth/authorize?"+e.toString())},handleOAuthRedirect:async function(){const e=new URL(window.location.href),t=new URLSearchParams(e.hash.slice(1)),n=t.get("access_token");null!==n?(await GM.setValue("anilist_access_token",n),await GM.setValue("anilist_expires_at",1e3*parseInt(t.get("expires_in"),10)+Date.now()),document.body.appendChild(document.createTextNode("Successfully authenticated with AniList ✅. You can now close this window."))):document.body.appendChild(document.createTextNode("Failed to authenticate with AniList ⚠️. Please try again."))},updateEntry:async function(e,t){t=Math.floor(t);let a=await n("\nquery ($id: Int) {\n    Media(id: $id, type: MANGA) {\n        id\n        chapters\n        mediaListEntry {\n            id\n            status\n            progress\n            repeat\n            startedAt {\n                year\n                month\n                day\n            }\n            completedAt {\n                year\n                month\n                day\n            }\n        }\n    }\n}\n",{id:e}),i=JSON.parse(a.responseText);if(i.errors?.length>0)return console.error(i.errors),!1;const s=i.data.Media,o=s.mediaListEntry;if(o.progress>=t)return!0;const r=new Date,l={year:r.getFullYear(),month:r.getMonth()+1,day:r.getDate()},c={progress:t};if(s.chapters==t?(c.status="COMPLETED",c.completedAt=l):c.status="CURRENT",void 0===o)c.mediaId=e,c.startedAt=l;else{if(!["CURRENT","DROPPED","PAUSED","PLANNING"].includes(o.status))return!0;c.id=o.id}return a=await n("\nmutation (\n    $id: Int, $mediaId: Int,\n    $status: MediaListStatus, $progress: Int, $repeat: Int,\n    $startedAt: FuzzyDateInput, $completedAt: FuzzyDateInput\n) {\n    SaveMediaListEntry (\n        id: $id, mediaId: $mediaId,\n        status: $status, progress: $progress, repeat: $repeat,\n        startedAt: $startedAt, completedAt: $completedAt\n    ) {\n        id\n        mediaId\n        status\n        progress\n        repeat\n        startedAt {\n            year\n            month\n            day\n        }\n        completedAt {\n            year\n            month\n            day\n        }\n    }\n}\n",c),i=JSON.parse(a.responseText),!(i.errors?.length>0)||(console.error(i.errors),!1)},search:async function(e){const n={query:"\nquery ($search: String) {\n    Page {\n        media(search: $search, type: MANGA) {\n        id\n        idMal\n        title {\n            romaji\n            english\n            native\n        }\n        format\n        startDate {\n            year\n        }\n        coverImage {\n            medium\n        }\n        synonyms\n        siteUrl\n        }\n    }\n}\n",variables:{search:e}};return new Promise(((e,a)=>{GM.xmlHttpRequest({url:t,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(n),onload:t=>e(JSON.parse(t.responseText)),onerror:a})}))}};async function i(e){await GM.setValue("config",JSON.stringify(e))}function s(e,t){const n=e.series[t];return void 0===n||null===n.parseFileForChapterNumber?e.parseFileForChapterNumber:n.parseFileForChapterNumber}const o="https://api.mangaupdates.com/v1";async function r(e,t,n){const a=await GM.getValue("mu_session_token");return new Promise(((i,s)=>{GM.xmlHttpRequest({url:o+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},data:void 0!==n?JSON.stringify(n):void 0,onload:e=>(401===e.status&&(GM.deleteValue("mu_session_token"),alert("MangaUpdates session expired, please login again.")),i(e)),onerror:e=>(console.error(e),s(e))})}))}const l={login:async function(e){const t="[komga-sync] ",n=document.createElement("div");n.classList.add("mu-login"),e.appendChild(n);const a=document.createElement("form");n.appendChild(a),a.insertAdjacentHTML("afterbegin",'\n<div class="mu-login-title">MangaUpdates Login</div>\n<div class="mu-login-desc">\nNote: The MangaUpdates API does not support OAuth.\nUsername and password are required to create a session token.\n</div>\n<div id="mu-login-error"></div>\n<div>\n<label for="mu-username">Username:</label>\n<input type="text" id="mu-username" name="username" required>\n</div>\n<div>\n<label for="mu-password">Password:</label>\n<input type="password" id="mu-password" name="password" required>\n</div>\n<div>\n<button type="submit">Login</button>\n<button type="button">Cancel</button>\n</div>'),a.querySelector("button:nth-child(2)").addEventListener("click",(()=>n.remove())),a.addEventListener("submit",(e=>{e.preventDefault();const i=new FormData(a);GM.xmlHttpRequest({url:o+"/account/login",method:"PUT",headers:{"Content-Type":"application/json"},data:JSON.stringify({username:i.get("username"),password:i.get("password")}),onload:async e=>{const i=JSON.parse(e.responseText);"success"===i.status?(await GM.setValue("mu_session_token",i.context.session_token),await GM.setValue("mu_uid",i.context.uid),console.log(t+"MangaUpdates login successful"),n.remove()):(a.querySelector("#mu-login-error").textContent="⚠️"+i.reason,console.error(t+"MangaUpdates login failed:",i.reason))},onerror:e=>console.error(t+"MangaUpdates login error",e)})}))},getToken:async function(){return await GM.getValue("mu_session_token")},updateSeries:async function(e,t){if(t=Math.floor(t),""===await GM.getValue("mu_session_token",""))return!1;const n={series:{id:e},status:{chapter:t}};let a="/lists/series",i=await r("/lists/series/"+e,"GET");if(404===i.status)n.list_id=0;else{if(JSON.parse(i.responseText).status.chapter>=t)return!0;a+="/update"}return i=await r(a,"POST",[n]),200===i.status},search:async function(e){return new Promise(((t,n)=>{GM.xmlHttpRequest({url:o+"/series/search",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({search:e}),onload:e=>t(JSON.parse(e.responseText)),onerror:n})}))}},c="https://myanimelist.net/v1/oauth2",d="https://api.myanimelist.net/v2",u="ZjE4NDIxNGY4MTg4Y2RmNzEwZmM4N2MwMzMzYzhlMGM";function p(e){const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let n="";for(let a=e;a>0;--a)n+=t[Math.floor(62*Math.random())];return n}async function m(e,t){const n={client_id:atob(u),client_secret:""};void 0!==e&&void 0!==t?Object.assign(n,{grant_type:"authorization_code",code:e,code_verifier:t}):Object.assign(n,{grant_type:"refresh_token",refresh_token:await GM.getValue("mal_refresh_token")});const a=new URLSearchParams(n).toString();return new Promise(((e,t)=>{GM.xmlHttpRequest({url:c+"/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:a,onload:t=>{if(200===t.status){const n=JSON.parse(t.responseText);return GM.setValue("mal_access_token",n.access_token),GM.setValue("mal_refresh_token",n.refresh_token),GM.setValue("mal_expires_at",Date.now()+2592e6),e(!0)}return alert("MyAnimeList session expired, please login again."),console.error(t),e(!1)},onerror:e=>(console.error(e),t(!1))})}))}async function h(e,t,n){const a=await GM.getValue("mal_access_token");let i=n;return void 0!==i&&(i=new URLSearchParams(i).toString()),new Promise(((s,o)=>{GM.xmlHttpRequest({url:d+e,method:t,headers:{Authorization:"Bearer "+a,"Content-Type":"application/x-www-form-urlencoded"},data:i,onload:async a=>401===a.status&&await m()?h(e,t,n):s(a),onerror:e=>(console.error(e),o(e))})}))}const g={getToken:async function(){return await GM.getValue("mal_access_token")},checkTokenExpiration:async function(){const e=await GM.getValue("mal_expires_at",null);null!==e&&e<=Date.now()&&(await GM.deleteValue("mal_access_token"),await GM.deleteValue("mal_expires_at"),alert("MyAnimeList session has expired, please login again."))},openOAuth:async function(){const e=p(16),t=p(64);await GM.setValue("mal_state",e),await GM.setValue("mal_challenge",t);const n=new URLSearchParams({response_type:"code",client_id:atob(u),state:e,code_challenge:t,code_challenge_method:"plain"});GM.openInTab(c+"/authorize?"+n.toString())},handleOAuthRedirect:async function(){const e=new URL(window.location.href),t=await GM.getValue("mal_state");if(e.searchParams.get("state")!==t)return void document.body.appendChild(document.createTextNode("Error: Authorization state does not match"));const n=await GM.getValue("mal_challenge"),a=e.searchParams.get("code");await m(a,n).catch((()=>!1))?document.body.appendChild(document.createTextNode("Successfully authenticated with MyAnimeList ✅. You can now close this window.")):document.body.appendChild(document.createTextNode("Failed to authenticate with MyAnimeList ⚠️. Error details were logged to console.")),GM.deleteValue("mal_state"),GM.deleteValue("mal_challenge")},updateStatus:async function(e,t){t=Math.floor(t);let n=await h("/manga/"+e+"?fields=my_list_status,num_chapters,status","GET");const a=JSON.parse(n.responseText),i=a.my_list_status??{is_rereading:!1,num_chapters_read:0,status:"plan_to_read"};if(i.num_chapters_read>=t)return!0;const s={num_chapters_read:t},o=(new Date).toISOString().substring(0,10);return"plan_to_read"===i.status?(s.status="reading",void 0===i.start_date&&(s.start_date=o)):"reading"===i.status&&t>=a.num_chapters&&"finished"===a.status&&(s.status="completed",void 0===i.finish_date&&(s.finish_date=o)),n=await h("/manga/"+e+"/my_list_status","PATCH",s),200===n.status},search:async function(e){const t=new URL(d+"/manga");return t.searchParams.set("q",e),t.searchParams.set("fields","start_date, media_type, alternative_titles"),t.searchParams.set("nsfw","true"),new Promise(((e,n)=>{GM.xmlHttpRequest({url:t.toString(),method:"GET",headers:{"X-MAL-CLIENT-ID":atob(u)},onload:t=>e(JSON.parse(t.responseText)),onerror:n})}))},randStr:p};(async()=>{const t="[komga-sync] ";if("komga-sync MAL auth"===document.title)return g.handleOAuthRedirect();if("komga-sync AniList auth"===document.title)return a.handleOAuthRedirect();if(!document.title.startsWith("Komga"))return;const n=await async function(){const e={parseFileForChapterNumber:!1,series:{}};return Object.assign(e,JSON.parse(await GM.getValue("config","{}"))),e}(),o={id:"",title:"",number:"0",pagesCount:0,seriesId:"",seriesTitle:"",completed:!1,links:[]};let r=!1,c=!1;setInterval((async()=>{const d=new URL(window.location.href);let p=d.pathname.match(/series\/([^/]+)/);if(p){const e=p[1];if(!r){const t=document.querySelector("main header > div.v-toolbar__content div.spacer");if(null===t)return;const s=document.createElement("button");s.className="v-btn v-btn--icon v-btn--round theme--dark v-size--default",s.style.width="120px",s.textContent="Komga Sync",s.addEventListener("click",(()=>{!async function(e){const t=document.createElement("div");t.classList.add("modal");const s=document.createElement("div");s.classList.add("content"),t.appendChild(s);const o=document.createElement("div");o.classList.add("header"),s.appendChild(o);const r=document.createElement("div");r.classList.add("header-title"),r.textContent="Komga-Sync",o.appendChild(r);const c=document.createElement("div");o.appendChild(c);const d=document.createElement("button");function p(){t.remove(),u.removeEventListener("click",h),window.removeEventListener("keydown",f)}function h(e){e.target==t&&p()}function f(e){"Escape"===e.code&&p()}d.textContent="❌",c.appendChild(d),d.addEventListener("click",p),u.addEventListener("click",h),window.addEventListener("keydown",f);const b=document.createElement("div");b.classList.add("global-conf"),s.appendChild(b);const y=document.createElement("div");b.appendChild(y);const w=function(e){const t=document.createElement("div");function n(t){switch(t.target.value){case"komga":e.parseFileForChapterNumber=!1;break;case"file":e.parseFileForChapterNumber=!0}i(e)}return t.insertAdjacentHTML("afterbegin",`\n<div class="global-conf-title">Global Configuration</div>\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file" id="config-parse-file-komga"\n        value="komga" ${!1===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-komga">Komga</label>\n    <input type="radio" name="config-parse-file" id="config-parse-file-file"\n        value="file" ${!0===e.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-file">Parse Filename</label>\n</div>`),t.querySelector("#config-parse-file-komga").addEventListener("change",n),t.querySelector("#config-parse-file-file").addEventListener("change",n),t}(n);b.appendChild(w);const x=document.createElement("button");x.textContent="MangaUpdates Login",x.className="login-button",y.appendChild(x),x.addEventListener("click",(()=>{l.login(y)})),void 0!==await l.getToken()&&y.appendChild(document.createTextNode(" Logged in ✅"));y.appendChild(document.createElement("br"));const v=document.createElement("button");v.textContent="MyAnimeList Login",v.className="login-button",y.appendChild(v),v.addEventListener("click",g.openOAuth),void 0!==await g.getToken()&&y.appendChild(document.createTextNode(" Logged in ✅"));y.appendChild(document.createElement("br"));const C=document.createElement("button");C.textContent="AniList Login",C.className="login-button",y.appendChild(C),C.addEventListener("click",a.openOAuth),void 0!==await a.getToken()&&y.appendChild(document.createTextNode(" Logged in ✅"));const k=await fetch("/api/v1/series/"+e),L=await k.json(),_=document.createElement("h2");_.textContent=L.metadata.title??L.name,s.appendChild(_);const M=function(e,t){e.series[t]||(e.series[t]={parseFileForChapterNumber:null});const n=e.series[t],a=document.createElement("div");function s(t){switch(t.target.value){case"global":n.parseFileForChapterNumber=null;break;case"komga":n.parseFileForChapterNumber=!1;break;case"file":n.parseFileForChapterNumber=!0}i(e)}return a.insertAdjacentHTML("afterbegin",`\n<div>\n    <span>Chapter Number Source:</span>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-global"\n        value="global" ${null===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-global">Global Setting</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-komga"\n        value="komga" ${!1===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-komga">Komga</label>\n    <input type="radio" name="config-parse-file-series" id="config-parse-file-series-file"\n        value="file" ${!0===n.parseFileForChapterNumber?"checked":""}>\n    <label for="config-parse-file-series-file">Parse Filename</label>\n</div>\n`),a.querySelector("#config-parse-file-series-global").addEventListener("change",s),a.querySelector("#config-parse-file-series-komga").addEventListener("change",s),a.querySelector("#config-parse-file-series-file").addEventListener("change",s),a}(n,e);M.classList.add("series-conf"),s.appendChild(M);const E={mu:"",mal:"",al:""};for(const e of L.metadata.links){switch(e.label){case"MangaUpdates":E.mu=e.url;break;case"MyAnimeList":E.mal=e.url;break;case"AniList":E.al=e.url}switch(new URL(e.url).hostname){case"mangaupdates.com":case"www.mangaupdates.com":E.mu||(E.mu=e.url);break;case"myanimelist.net":case"www.myanimelist.net":E.mal||(E.mal=e.url);break;case"anilist.co":case"www.anilist.co":E.al||(E.al=e.url)}}function A(e,t,n){const a=document.createElement("label");a.textContent=e,n.appendChild(a);const i=document.createElement("input");i.type="url",i.value=t,n.appendChild(i);const s=document.createElement("button");return s.textContent="Search "+e,n.appendChild(document.createElement("br")),[i,s]}const N=document.createElement("div");N.classList.add("links");const[S,T]=A("MangaUpdates",E.mu,N),[G,F]=A("MyAnimeList",E.mal,N),[P,R]=A("AniList",E.al,N);let U=document.createElement("label");U.textContent="Search Term:",N.appendChild(U);const O=document.createElement("input");O.value=L.metadata.title??L.name,O.type="text",O.classList.add("search-input"),N.appendChild(O);const I=document.createElement("div");I.classList.add="button-container",I.appendChild(T),I.appendChild(F),I.appendChild(R),N.appendChild(I);const z=document.createElement("div");z.classList.add("button-note"),z.textContent=" Note: AniList has MyAnimeList IDs for most entries, if MAL is still missing it will also be added if available.",N.appendChild(z),s.appendChild(N);const V=async(t,n)=>{const a=L.metadata.links.filter((e=>e.label!==t));a.push({label:t,url:n});204===(await fetch("/api/v1/series/"+e+"/metadata",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({links:a})})).status&&(L.metadata.links=a)},q=(e,t,n)=>{const a=document.createElement("div");a.classList.add("result-container"),s.appendChild(a),m[e][t]=a,setTimeout((()=>delete m[e][t]),3e5);const i=document.createElement("h3");if(i.textContent=e+" Results",i.classList.add("result-header"),void 0!==n&&i.classList.add("result-header-with-note"),a.appendChild(i),void 0!==n){const e=document.createElement("div");e.classList.add("result-note"),e.textContent=n,a.appendChild(e)}const o=document.createElement("div");return o.classList.add("result-list"),a.appendChild(o),o},$=(e,t,n,a,i,s)=>{a=a.replace("_"," ").toLowerCase();const o=document.createElement("div");o.classList.add("result-card");const r=document.createElement("div");r.classList.add("thumb"),o.appendChild(r);const l=document.createElement("img");l.src=e,r.appendChild(l);const c=document.createElement("details");o.appendChild(c),l.addEventListener("click",(()=>{c.toggleAttribute("open")}));const d=document.createElement("summary");d.innerHTML=`${n} <a href="${t}" target="_blank">🔗</a> <span>${a}</span>`+(i?` [${i}]`:""),c.appendChild(d),c.insertAdjacentHTML("beforeend",s??"");const u=document.createElement("button");return u.textContent="Set URL",o.appendChild(u),{card:o,button:u}};T.addEventListener("click",(async()=>{const e=O.value.trim();if(u.querySelector(".result-container")?.remove(),m.MangaUpdates[e])return void s.appendChild(m.MangaUpdates[e]);const t=await l.search(e),n=q("MangaUpdates",e);for(const{record:e}of t.results){const{card:t,button:a}=$(e.image.url.thumb,e.url,e.title,e.type,e.year);a.addEventListener("click",(async()=>{S.value=e.url,await V("MangaUpdates",e.url)})),n.appendChild(t)}})),F.addEventListener("click",(async()=>{const e=O.value.trim();if(u.querySelector(".result-container")?.remove(),m.MyAnimeList[e])return void s.appendChild(m.MyAnimeList[e]);const t=await g.search(e),n=q("MyAnimeList",e,"Click on the series thumbnail or title to show synonyms.");for(const{node:e}of t.data){const t="https://myanimelist.net/manga/"+e.id,a=e.alternative_titles,{card:i,button:s}=$(e.main_picture.medium,t,e.title,e.media_type,e.start_date?.slice(0,4),(""!==a.en?a.en+"<br>":"")+a.ja+(a.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+a.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));s.addEventListener("click",(async()=>{G.value=t,await V("MyAnimeList",t)})),n.appendChild(i)}})),R.addEventListener("click",(async()=>{u.querySelector(".result-container")?.remove();const e=O.value.trim();if(m.AniList[e])return void s.appendChild(m.AniList[e]);const t=await a.search(e),n=q("AniList",e,"Click on the series thumbnail or title to show synonyms.");for(const e of t.data.Page.media){const{card:t,button:a}=$(e.coverImage.medium,e.siteUrl,e.title.english??e.title.romaji??e.title.native,e.format,e.startDate.year,(e.title.romaji?e.title.romaji+"<br>":"")+e.title.native+(e.synonyms.length>0?"<br><b>Synonyms:</b><ul>"+e.synonyms.reduce(((e,t)=>e+`<li>${t}</li>`),"")+"</ul>":""));a.addEventListener("click",(async()=>{if(await V("AniList",e.siteUrl),P.value=e.siteUrl,null!==e.idMal&&""===G.value){const t="https://myanimelist.net/manga/"+e.idMal;await V("MyAnimeList",t),G.value=t}})),n.appendChild(t)}})),u.appendChild(t)}(e),s.blur()})),t.parentNode.insertBefore(s,t.nextSibling),r=!0}}else r=!1;if(p=d.pathname.match(/book\/([^/]+)\/read/),p){if(o.id!==p[1]){o.id=p[1];let a=await fetch("/api/v1/books/"+o.id),i=await a.json();o.title=i.metadata.title,s(n,o.seriesId)?o.number=e.parseChapterNumber(i.seriesTitle,i.url):o.number=i.metadata.number,o.pagesCount=i.media.pagesCount,o.seriesId=i.seriesId,o.seriesTitle=i.seriesTitle,o.completed=!1,console.log(t+"Chapter opened: "+o.seriesTitle+" Ch. "+o.number+": "+o.title),a=await fetch("/api/v1/series/"+o.seriesId),i=await a.json(),o.links=i.metadata.links}if("false"!==d.searchParams.get("incognito"))return;if(!o.completed&&Number(d.searchParams.get("page"))==o.pagesCount){o.completed=!0,console.log(t+"Chapter complete, syncing..");const e=[["MangaUpdates",l.updateSeries],["MyAnimeList",g.updateStatus],["AniList",a.updateEntry]];for(const[n,a]of e){const e=o.links.find((e=>e.label===n));if(e)try{const i=h(e.url);!0===await a(i,o.number)&&console.log(t+"Successfully synced with "+n)}catch(e){console.error(t+"Error syncing with "+n,e)}}}}else""!==o.id&&(console.log(t+"Chapter closed"),o.id="");if(p=d.pathname.match(/book\/([^/]+)\/?$/),null!==p){const t=document.querySelector("a.link-underline.text-h5")?.href.match(/series\/([^/]+)/)?.[1];void 0!==t&&(c=!(!c&&s(n,t))||function(){const t=document.querySelector("div.container.pa-6.container--fluid");if(null===t)return!1;const n=Array.from(t.children).find((e=>"FILE"===e.firstChild.textContent)).lastChild.textContent.split(/\/|\\/).pop(),a=t.querySelector("a.link-underline.text-h5").textContent.trim()??"",i=e.parseChapterNumber(a,n),s=document.createElement("div");s.className="row align-center text-caption";const o=document.createElement("div");o.className="py-1 text-uppercase col-sm-3 col-md-2 col-xl-1 col-4";const r=document.createElement("div");return r.className="py-1 col-sm-9 col-md-10 col-xl-11 col-8",o.textContent="Parsed Chapter",r.textContent=i,s.appendChild(o),s.appendChild(r),t.appendChild(s),!0}())}else c=!1}),250),g.checkTokenExpiration(),a.checkTokenExpiration();const d=document.createElement("div");document.body.appendChild(d);const u=d.attachShadow({mode:"open"}),p=document.createElement("style");p.textContent='.modal {\n    z-index: 300;\n    position: fixed;\n    padding-top: 100px;\n    transform: translate(0, 0);\n    left: 0;\n    top: 0;\n    bottom: 0;\n    right: 0;\n    width: auto;\n    height: auto;\n    overflow: auto;\n    background-color: rgba(0, 0, 0, 0.8);\n    overscroll-behavior: contain;\n}\n\n.header {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 0.5em;\n}\n\n.header-title {\n    font-size: 1.8em;\n    font-weight: bold;\n}\n\n.global-conf {\n    display: flex;\n    gap: 3em;\n}\n\n.global-conf-title {\n    font-weight: bold;\n    margin: 2px;\n    margin-bottom: 0.5em;\n}\n\n.global-conf input {\n    margin: 2px;\n}\n\n.global-conf label {\n    margin: 2px;\n}\n\n.series-conf {\n    margin-bottom: 0.5em;\n}\n\n.content {\n    font-family: Roboto, sans-serif;\n    font-size: 16px;\n    color: #ffffff;\n    background-color: #121212;\n    margin: auto;\n    width: 80%;\n    padding: 1em;\n    border: 1px solid #696969;\n    border-radius: 10px;\n}\n\nh2 {\n    margin-top: 1em;\n    margin-bottom: 0.5em;\n}\n\n.links label {\n    display: inline-block;\n    width: 120px;\n}\n\nbutton {\n    background-color: #303030;\n    border: 2px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    padding: 6px 16px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    font-size: 16px;\n    margin: 2px;\n    transition-duration: 0.2s;\n    cursor: pointer;\n}\n\nbutton:hover {\n    background-color: #ffffff;\n    color: #000000;\n}\n\n.login-button {\n    width: 200px;\n}\n\n.links input,\ninput[type="text"],\ninput[type="password"] {\n    padding: 5px;\n    margin: 2px;\n    box-sizing: border-box;\n    border: 1px solid #303030;\n    border-radius: 5px;\n    color: #ffffff;\n    background-color: #303030;\n    font-size: 16px;\n    width: 100%;\n    max-width: 800px;\n}\n\n.links .search-input {\n    margin-top: 16px;\n}\n\n.button-container {\n    margin-top: 8px;\n}\n\n.button-note {\n    font-size: 14px;\n    margin: 5px 2px;\n}\n\na {\n    text-decoration: none;\n    color: #ffffff;\n}\n\n.result-note {\n    font-size: 14px;\n    margin-bottom: 1em;\n}\n\n.result-header {\n    margin-top: 1em;\n    margin-bottom: 1em;\n}\n\n.result-header-with-note {\n    margin-bottom: 0.25em;\n}\n\n.result-list {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.5em;\n}\n\n.result-card {\n    border: 1px solid #000;\n    background-color: #232323;\n    flex-basis: 400px;\n    flex-grow: 1;\n}\n\n.result-card .thumb {\n    float: left;\n    margin-right: 4px;\n    width: 106px;\n}\n\n.result-card img {\n    display: block;\n    height: 150px;\n    width: 106px;\n    object-fit: contain;\n}\n\n.result-card details {\n    margin: 5px;\n}\n\n.result-card summary {\n    font-weight: bold;\n}\n\n.result-card summary span {\n    text-transform: capitalize;\n}\n\n.result-card button {\n    margin: 0.5em;\n    padding: 3px 8px;\n    border: 1px solid #404040;\n    font-size: 14px;\n}\n\n.result-card ul {\n    margin-top: 0.25em;\n    padding-left: 10px;\n    list-style: inside;\n    overflow: auto;\n}\n\n.mu-login {\n    z-index: 310;\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.8);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n}\n\n.mu-login form {\n    width: 100%;\n    max-width: 540px;\n    background-color: #121212;\n    border: 1px solid #696969;\n    border-radius: 10px;\n    padding: 1em;\n}\n\n.mu-login div {\n    margin: 6px;\n}\n\n.mu-login .mu-login-title {\n    font-size: 1.5em;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n\n.mu-login .mu-login-desc {\n    font-size: smaller;\n    margin-bottom: 12px;\n}\n\n#mu-login-error {\n    color: #ff0000;\n    font-weight: bold;\n    margin-bottom: 12px;\n}\n',u.appendChild(p);const m={MangaUpdates:{},MyAnimeList:{},AniList:{}};function h(e){let t=e.match(/^https:\/\/(?:www\.)?mangaupdates\.com\/series\/([^/]+)/i);if(t)return parseInt(t[1],36);if(t=e.match(/^https:\/\/(?:www\.)?myanimelist\.net\/manga\/([^/]+)/i),t)return parseInt(t[1],10);if(t=e.match(/^https:\/\/(?:www\.)?anilist\.co\/manga\/([^/]+)/i),t)return parseInt(t[1],10);throw new Error("Invalid URL")}})()}();
